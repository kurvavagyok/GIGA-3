
<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratóriumi Adatok Elemzése - Deep Discovery AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-black text-white min-h-screen">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold mb-8 text-center bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
            <i class="fas fa-microscope mr-3"></i>Laboratóriumi Adatok Elemzése
        </h1>

        <!-- Adatok feltöltése -->
        <div class="bg-gray-900 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">
                <i class="fas fa-upload text-blue-400 mr-2"></i>Kísérleti Adatok Feltöltése
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Kísérlet típusa</label>
                    <select id="experimentType" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3">
                        <option value="hplc">HPLC Kromatográfia</option>
                        <option value="gc_ms">GC-MS Tömegspektrometria</option>
                        <option value="uv_vis">UV-Vis Spektroszkópia</option>
                        <option value="nmr">NMR Spektroszkópia</option>
                        <option value="xrd">Röntgendiffrakció</option>
                        <option value="ftir">FTIR Spektroszkópia</option>
                        <option value="titration">Titrálás</option>
                        <option value="enzyme_assay">Enzimvizsgálat</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Minta információ</label>
                    <input type="text" id="sampleInfo" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3" 
                           placeholder="Minta neve, koncentráció, pH, hőmérséklet...">
                </div>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm font-medium mb-2">Mért adatok (CSV formátum)</label>
                <textarea id="labData" rows="8" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3" 
                    placeholder="Idő,Jel,Koncentráció
0.5,1250,0.1
1.0,2480,0.2
1.5,3720,0.3
..."></textarea>
            </div>
            
            <div class="mt-4">
                <label class="block text-sm font-medium mb-2">Referencia/standard értékek</label>
                <textarea id="referenceData" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3" 
                    placeholder="Ismert koncentrációk, elméleti értékek..."></textarea>
            </div>
            
            <button id="analyzeLabData" class="mt-4 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 px-6 py-3 rounded-lg font-medium transition-all">
                <i class="fas fa-chart-line mr-2"></i>Adatok Elemzése
            </button>
        </div>

        <!-- Elemzési eredmények -->
        <div id="labResults" class="hidden">
            <!-- Kalibrációs görbe -->
            <div class="bg-gray-900 rounded-xl p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-chart-line text-green-400 mr-2"></i>Kalibrációs Görbe és Linearitás
                </h3>
                <div id="calibrationPlot" class="w-full h-96 mb-4"></div>
                <div id="calibrationStats" class="grid md:grid-cols-4 gap-4"></div>
            </div>

            <!-- Minőségbiztosítás -->
            <div class="bg-gray-900 rounded-xl p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-shield-alt text-yellow-400 mr-2"></i>Minőségbiztosítási Paraméterek
                </h3>
                <div id="qualityMetrics" class="grid md:grid-cols-3 gap-4"></div>
            </div>

            <!-- AI ajánlások -->
            <div class="bg-gray-900 rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-4">
                    <i class="fas fa-robot text-purple-400 mr-2"></i>AI Ajánlások és Következtetések
                </h3>
                <div id="aiRecommendations" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('analyzeLabData').addEventListener('click', async () => {
            const experimentType = document.getElementById('experimentType').value;
            const sampleInfo = document.getElementById('sampleInfo').value;
            const labData = document.getElementById('labData').value;
            const referenceData = document.getElementById('referenceData').value;

            if (!labData.trim()) {
                alert('Kérlek add meg a laboratóriumi adatokat!');
                return;
            }

            try {
                // AI elemzés kérése
                const response = await fetch('/api/deep_discovery/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Laboratóriumi adatok elemzése:
                        Kísérlet típusa: ${experimentType}
                        Minta: ${sampleInfo}
                        Mért adatok: ${labData}
                        Referencia: ${referenceData}
                        
                        Kérem:
                        1. Statisztikai elemzés (átlag, szórás, RSD%, LOD, LOQ)
                        2. Kalibrációs görbe értékelése (R², lineáris tartomány)
                        3. Minőségbiztosítási paraméterek
                        4. Gyakorlati ajánlások a módszer javítására
                        5. Következő lépések javaslata`,
                        user_id: 'lab_analyzer_' + Date.now()
                    })
                });

                const analysisData = await response.json();
                
                // Eredmények megjelenítése
                document.getElementById('labResults').classList.remove('hidden');
                
                // Adatok feldolgozása
                const dataLines = labData.trim().split('\n');
                const headers = dataLines[0].split(',');
                const values = dataLines.slice(1).map(line => line.split(',').map(Number));
                
                // Kalibrációs görbe
                createCalibrationCurve(values, headers);
                
                // Minőségbiztosítási paraméterek
                calculateQualityMetrics(values);
                
                // AI ajánlások
                displayAIRecommendations(analysisData.response);

            } catch (error) {
                console.error('Laboratóriumi elemzési hiba:', error);
                alert('Hiba történt az elemzés során: ' + error.message);
            }
        });

        function createCalibrationCurve(values, headers) {
            if (values.length < 2 || values[0].length < 2) return;

            const x = values.map(row => row[0]);
            const y = values.map(row => row[1]);

            // Lineáris regresszió
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);

            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;

            // R² számítás
            const yMean = sumY / n;
            const ssRes = y.reduce((sum, yi, i) => sum + Math.pow(yi - (slope * x[i] + intercept), 2), 0);
            const ssTot = y.reduce((sum, yi) => sum + Math.pow(yi - yMean, 2), 0);
            const r2 = 1 - (ssRes / ssTot);

            // Grafikon
            const trace1 = {
                x: x,
                y: y,
                mode: 'markers',
                type: 'scatter',
                name: 'Mért pontok',
                marker: { color: '#3B82F6', size: 8 }
            };

            const trace2 = {
                x: x,
                y: x.map(xi => slope * xi + intercept),
                mode: 'lines',
                type: 'scatter',
                name: 'Kalibrációs egyenes',
                line: { color: '#10B981', width: 3 }
            };

            const layout = {
                title: 'Kalibrációs Görbe',
                xaxis: { title: headers[0] || 'Koncentráció' },
                yaxis: { title: headers[1] || 'Jel' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'white' }
            };

            Plotly.newPlot('calibrationPlot', [trace1, trace2], layout, {responsive: true});

            // Statisztikák
            const stats = [
                { label: 'R²', value: r2.toFixed(4), color: 'text-green-400' },
                { label: 'Meredekség', value: slope.toFixed(4), color: 'text-blue-400' },
                { label: 'Tengelymetszet', value: intercept.toFixed(4), color: 'text-purple-400' },
                { label: 'Adatpontok', value: n, color: 'text-yellow-400' }
            ];

            document.getElementById('calibrationStats').innerHTML = stats.map(stat => `
                <div class="text-center p-4 bg-gray-800 rounded-lg">
                    <div class="text-2xl font-bold ${stat.color}">${stat.value}</div>
                    <div class="text-sm text-gray-400">${stat.label}</div>
                </div>
            `).join('');
        }

        function calculateQualityMetrics(values) {
            if (values.length < 2) return;

            const y = values.map(row => row[1]);
            const mean = y.reduce((a, b) => a + b, 0) / y.length;
            const variance = y.reduce((sum, yi) => sum + Math.pow(yi - mean, 2), 0) / (y.length - 1);
            const stdDev = Math.sqrt(variance);
            const rsd = (stdDev / mean) * 100;

            // LOD és LOQ becslés (3σ és 10σ)
            const lod = 3 * stdDev;
            const loq = 10 * stdDev;

            const metrics = [
                { label: 'Átlag', value: mean.toFixed(2), icon: 'fas fa-chart-bar' },
                { label: 'Szórás', value: stdDev.toFixed(2), icon: 'fas fa-wave-square' },
                { label: 'RSD%', value: rsd.toFixed(2) + '%', icon: 'fas fa-percentage' },
                { label: 'LOD', value: lod.toFixed(2), icon: 'fas fa-search' },
                { label: 'LOQ', value: loq.toFixed(2), icon: 'fas fa-crosshairs' },
                { label: 'Pontosság', value: (100 - Math.abs(rsd)).toFixed(1) + '%', icon: 'fas fa-bullseye' }
            ];

            document.getElementById('qualityMetrics').innerHTML = metrics.map(metric => `
                <div class="text-center p-4 bg-gray-800 rounded-lg">
                    <i class="${metric.icon} text-2xl text-green-400 mb-2"></i>
                    <div class="text-xl font-bold">${metric.value}</div>
                    <div class="text-sm text-gray-400">${metric.label}</div>
                </div>
            `).join('');
        }

        function displayAIRecommendations(aiResponse) {
            const recommendations = document.getElementById('aiRecommendations');
            recommendations.innerHTML = `
                <div class="p-4 bg-gray-800 rounded-lg">
                    <div class="prose prose-invert max-w-none">
                        ${aiResponse.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
